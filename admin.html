<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.gstatic.com https://cdn.sheetjs.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://firestore.googleapis.com; frame-src https://www.google.com;" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>ISTE Admin Portal</title>
    <meta name="description" content="ISTE Club Admin Portal - Manage events, registrations, and winners." />
    <script src="https://www.google.com/recaptcha/api.js?render=6LeeoD8sAAAAAGKAdRH9D4ca5FHGsip-XXGcXOzM"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="css/admin.css" />
</head>

<body>
    <div class="bg-animation">
        <div class="bg-orb bg-orb-1"></div>
        <div class="bg-orb bg-orb-2"></div>
        <div class="bg-orb bg-orb-3"></div>
    </div>

    <div class="toast" id="toast">Action completed!</div>

    <div class="bulk-action-bar" id="bulkActionBar">
        <span class="bulk-count" id="bulkCount">0 selected</span>
        <div class="bulk-actions">
            <button class="bulk-btn verify" onclick="bulkUpdateStatus('verified')">âœ“ Verify</button>
            <button class="bulk-btn delete" onclick="bulkDeleteSelected()">ğŸ—‘ï¸ Delete</button>
            <button class="bulk-btn cancel" onclick="clearBulkSelection()">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <span class="modal-title">âœï¸ Edit Team</span>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <input type="hidden" id="editTeamId">
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">ğŸ·ï¸ Team Info</p>
                <div class="form-group">
                    <label>Team Name</label>
                    <input type="text" id="editTeamName" placeholder="e.g. Code Crushers">
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin: 20px 0 16px; text-transform: uppercase; letter-spacing: 1px;">ğŸ‘¤ Member 1</p>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editM1Name" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Details (USN â€¢ Dept)</label>
                    <input type="text" id="editM1Detail" placeholder="1CR23CS001 â€¢ CSE">
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin: 20px 0 16px; text-transform: uppercase; letter-spacing: 1px;">ğŸ‘¤ Member 2</p>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editM2Name" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Details (USN â€¢ Dept)</label>
                    <input type="text" id="editM2Detail" placeholder="1CR23CS002 â€¢ CSE">
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin: 20px 0 16px; text-transform: uppercase; letter-spacing: 1px;">ğŸ‘¤ Member 3</p>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editM3Name" placeholder="Enter name (optional)">
                </div>
                <div class="form-group">
                    <label>Details (USN â€¢ Dept)</label>
                    <input type="text" id="editM3Detail" placeholder="1CR23CS003 â€¢ CSE">
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin: 20px 0 16px; text-transform: uppercase; letter-spacing: 1px;">ğŸ“§ Contact</p>
                <div class="form-group">
                    <label>Team Email</label>
                    <input type="email" id="editEmail" placeholder="team@example.com">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ğŸ—‘ï¸ Delete Team</span>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteTeamId">
                <div class="delete-warning">
                    <div class="icon">âš ï¸</div>
                    <p>Are you sure you want to delete</p>
                    <p><strong id="deleteTeamName">Team 1</strong>?</p>
                    <p style="color: var(--accent-red); font-size: 12px; margin-top: 12px;">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="winnerModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ğŸ† Set Winner</span>
                <button class="modal-close" onclick="closeModal('winnerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="winnerTeamId">
                <input type="hidden" id="winnerEventCode">
                <p style="text-align: center; margin-bottom: 8px;">Setting winner for:</p>
                <p style="text-align: center; font-weight: 700; font-size: 18px; color: var(--text-primary);" id="winnerTeamName">Team Name</p>
                <div class="winner-position-grid">
                    <button type="button" class="winner-position-btn gold" onclick="selectWinnerPosition(1, this)">
                        <div class="medal">ğŸ¥‡</div>
                        <div class="label">1st Place</div>
                    </button>
                    <button type="button" class="winner-position-btn silver" onclick="selectWinnerPosition(2, this)">
                        <div class="medal">ğŸ¥ˆ</div>
                        <div class="label">2nd Place</div>
                    </button>
                    <button type="button" class="winner-position-btn bronze" onclick="selectWinnerPosition(3, this)">
                        <div class="medal">ğŸ¥‰</div>
                        <div class="label">3rd Place</div>
                    </button>
                </div>
                <input type="hidden" id="selectedWinnerPosition" value="">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('winnerModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmSetWinner()" id="confirmWinnerBtn">Set as Winner</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createEventModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <span class="modal-title">â• Create New Event</span>
                <button class="modal-close" onclick="closeModal('createEventModal')">&times;</button>
            </div>
            <div class="modal-body create-event-form">
                <div class="form-group">
                    <label>Event Name</label>
                    <input type="text" id="newEventName" placeholder="e.g. Code Sprint 2.0">
                </div>
                <div class="form-group">
                    <label>Event Code (lowercase, no spaces)</label>
                    <input type="text" id="newEventCode" placeholder="e.g. codesprint" pattern="[a-z0-9_]+"
                        oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9_]/g, '')">
                </div>
                <div class="form-group">
                    <label>Select Icon</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <button type="button" class="emoji-option selected" data-emoji="ğŸ¯"
                            onclick="selectEventEmoji('ğŸ¯', this)">ğŸ¯</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ’»"
                            onclick="selectEventEmoji('ğŸ’»', this)">ğŸ’»</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ¨"
                            onclick="selectEventEmoji('ğŸ¨', this)">ğŸ¨</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸš€"
                            onclick="selectEventEmoji('ğŸš€', this)">ğŸš€</button>
                        <button type="button" class="emoji-option" data-emoji="âš¡"
                            onclick="selectEventEmoji('âš¡', this)">âš¡</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ”¥"
                            onclick="selectEventEmoji('ğŸ”¥', this)">ğŸ”¥</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ§ª"
                            onclick="selectEventEmoji('ğŸ§ª', this)">ğŸ§ª</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ®"
                            onclick="selectEventEmoji('ğŸ®', this)">ğŸ®</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ“±"
                            onclick="selectEventEmoji('ğŸ“±', this)">ğŸ“±</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ¤–"
                            onclick="selectEventEmoji('ğŸ¤–', this)">ğŸ¤–</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸª"
                            onclick="selectEventEmoji('ğŸª', this)">ğŸª</button>
                        <button type="button" class="emoji-option" data-emoji="ğŸ†"
                            onclick="selectEventEmoji('ğŸ†', this)">ğŸ†</button>
                    </div>
                    <input type="hidden" id="selectedEventEmoji" value="ğŸ¯">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createEventModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewEvent()">Create Event</button>
            </div>
        </div>
    </div>

    <!-- Team Detail Drawer -->
    <div class="drawer-overlay" id="teamDrawerOverlay">
        <div class="team-drawer" id="teamDrawer">
            <div class="drawer-header">
                <h3>ğŸ“‹ Team Details</h3>
                <button class="drawer-close" onclick="closeTeamDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="drawer-section">
                    <h4>Team Information</h4>
                    <div class="drawer-info-item">
                        <span class="drawer-info-label">Team Name</span>
                        <span class="drawer-info-value" id="drawerTeamName">â€”</span>
                    </div>
                    <div class="drawer-info-item">
                        <span class="drawer-info-label">Status</span>
                        <span class="drawer-info-value" id="drawerStatus">â€”</span>
                    </div>
                    <div class="drawer-info-item">
                        <span class="drawer-info-label">Email</span>
                        <span class="drawer-info-value" id="drawerEmail">â€”</span>
                    </div>
                    <div class="drawer-info-item">
                        <span class="drawer-info-label">Registered</span>
                        <span class="drawer-info-value" id="drawerRegisteredAt">â€”</span>
                    </div>
                </div>

                <div class="drawer-section">
                    <h4>Team Members</h4>
                    <div id="drawerMembers">
                        <!-- Members will be populated dynamically -->
                    </div>
                </div>

                <div class="drawer-section">
                    <h4>Quick Actions</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="drawerEditBtn" onclick="editFromDrawer()" style="flex: 1;">âœï¸ Edit</button>
                        <button class="btn btn-secondary" id="drawerVerifyBtn" onclick="verifyFromDrawer()" style="flex: 1;">âœ“ Verify</button>
                        <button class="btn btn-danger" id="drawerDeleteBtn" onclick="deleteFromDrawer()" style="flex: 1;">ğŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav id="navbar">
        <a href="index.html" class="logo">
            <img src="images/download.png" alt="ISTE Logo" />
            <div class="logo-text">
                <span>ISTE</span>
                <small>Admin Portal</small>
            </div>
        </a>
        <div class="nav-links" id="navLinks">
            <a href="index.html">Home</a>
            <a href="index.html#about">About</a>
            <a href="index.html#activity">Events</a>
            <a href="index.html#winners">Winners</a>
            <a href="index.html#gallery">Gallery</a>
            <a href="#" class="active">Admin</a>
        </div>
        <div class="hamburger" id="hamburger" onclick="toggleNav()" aria-label="Toggle navigation menu" role="button"
            tabindex="0">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="admin-wrapper">
        <div id="login-page" class="login-container">
            <div class="login-box">
                <h2>ğŸ” Admin Login</h2>
                <form id="loginForm" onsubmit="handleLogin(event); return false;" autocomplete="on">
                    <div class="form-group">
                        <label for="username">ğŸ‘¤ Email Address</label>
                        <input type="email" id="username" name="username" placeholder="Enter your email" 
                            required maxlength="254" minlength="5"
                            autocomplete="email" 
                            pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                            title="Please enter a valid email address" />
                    </div>
                    <div class="form-group">
                        <label for="password">ğŸ”’ Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="password" name="password" placeholder="Enter password" 
                                required minlength="8" maxlength="128"
                                autocomplete="current-password" />
                            <button type="button" class="password-toggle" id="passwordToggle"
                                onclick="togglePasswordVisibility()" aria-label="Toggle password visibility">
                                <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" style="display: none;">
                                    <path
                                        d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                                    </path>
                                    <line x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="error-message" id="errorMessage" role="alert" aria-live="polite">âŒ Invalid email or password</div>
                    <button type="submit" class="btn" id="loginBtn">Sign In</button>
                </form>
            </div>
        </div>

        <div id="admin-dashboard" class="dashboard">
            <div class="dashboard-header">
                <div class="dashboard-header-left">
                    <h2>ğŸ“Š Dashboard Overview</h2>
                    <p>Welcome back! Here's what's happening with your events.</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="settings-wrapper">
                        <button class="settings-btn" onclick="toggleSettingsDropdown()">âš™ï¸ Settings</button>
                        <div class="settings-dropdown" id="settingsDropdown">
                            <h4>âš™ï¸ Admin Settings</h4>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <span>ğŸ“§ Email Notifications</span>
                                    <small>Send email alerts for new registrations</small>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" id="emailNotifications" onchange="saveSettings()">
                                    <span class="settings-toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <span>ğŸ“ Registration Open</span>
                                    <small>Allow new team registrations</small>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" id="registrationOpen" checked onchange="saveSettings()">
                                    <span class="settings-toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <span>ğŸ”§ Maintenance Mode</span>
                                    <small>Show maintenance page to visitors</small>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" id="maintenanceMode" onchange="saveSettings()">
                                    <span class="settings-toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <div class="overview-grid">
                <div class="overview-card purple">
                    <div class="overview-card-icon">ğŸ‘¥</div>
                    <h3>Total Teams</h3>
                    <div class="number">18</div>
                    <div class="change positive">â†‘ 3 new this week</div>
                </div>
                <div class="overview-card green">
                    <div class="overview-card-icon">ğŸ¯</div>
                    <h3>Participants</h3>
                    <div class="number">48</div>
                    <div class="change positive">â†‘ 12 registered today</div>
                </div>
                <div class="overview-card orange">
                    <div class="overview-card-icon">ğŸ†</div>
                    <h3>Events</h3>
                    <div class="number">3</div>
                    <div class="change info">Active events</div>
                </div>
                <div class="overview-card pink">
                    <div class="overview-card-icon">ğŸ“¸</div>
                    <h3>Gallery Photos</h3>
                    <div class="number">24</div>
                    <div class="change info">Uploaded</div>
                </div>
            </div>

            <div class="content-grid">
                <div class="event-tabs-container">
                    <div class="event-tabs-header">
                        <h3>ğŸ“‹ Event Management</h3>
                    </div>

                    <div id="event-selector-view" class="event-selector-view">
                        <div class="routing-config-card">
                            <h4>ğŸ¯ Registration Routing</h4>
                            <div class="custom-select" id="routingDropdown">
                                <button type="button" class="select-trigger" onclick="toggleDropdown()">
                                    <span class="selected-value">
                                        <span class="icon">ğŸ§ª</span>
                                        <span id="selectedEventText">Testing (Sandbox)</span>
                                    </span>
                                    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <div class="select-content">
                                    <div class="select-item selected" data-value="testing" onclick="selectOption(this)">
                                        <span class="icon">ğŸ§ª</span>
                                        <span>Testing (Sandbox)</span>
                                        <span class="check">âœ“</span>
                                    </div>
                                    <div class="select-item" data-value="promptquest" onclick="selectOption(this)">
                                        <span class="icon">ğŸ¯</span>
                                        <span>PromptQuest</span>
                                        <span class="check">âœ“</span>
                                    </div>
                                    <div class="select-item" data-value="uibattle" onclick="selectOption(this)">
                                        <span class="icon">ğŸ¨</span>
                                        <span>UI Battle</span>
                                        <span class="check">âœ“</span>
                                    </div>
                                    <div class="select-item" data-value="hackathon" onclick="selectOption(this)">
                                        <span class="icon">ğŸ’»</span>
                                        <span>Hackathon</span>
                                        <span class="check">âœ“</span>
                                    </div>
                                </div>
                            </div>
                            <div class="routing-status" id="routingStatus">
                                <span class="dot"></span>
                                <span>New registrations â†’ <strong id="activeEventName">Testing</strong></span>
                            </div>
                        </div>

                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Select an event to
                            manage:</p>
                        <div class="event-selector-grid" id="eventSelectorGrid">
                            <!-- Event cards will be dynamically generated -->
                            <div class="event-loading" id="eventCardsLoader">
                                <div class="spinner"></div>
                                <p>Loading events...</p>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 24px;">
                            <button class="btn btn-secondary" onclick="openCreateEventModal()"
                                style="display: inline-flex; align-items: center; gap: 8px;">
                                â• Create New Event
                            </button>
                        </div>
                    </div>

                    <div id="event-detail-view" class="event-detail-view">
                        <button class="back-to-events" onclick="backToEventSelector()">â† Back to Events</button>

                        <div class="event-tabs" id="dynamicEventTabs">
                            <!-- Event tabs will be dynamically generated -->
                        </div>

                        <!-- Dynamic Event Content Container -->
                        <div id="dynamicEventContents">
                            <!-- Event content sections will be dynamically generated -->
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="sidebar-card">
                        <h3>âš¡ Quick Actions</h3>
                        <div class="quick-action" onclick="handleExport()">
                            <div class="quick-action-icon purple">ğŸ“¥</div>
                            <div class="quick-action-text">
                                <h4>Export Data</h4>
                                <p>Download as Excel</p>
                            </div>
                        </div>
                        <div class="quick-action" onclick="handleAddEvent()">
                            <div class="quick-action-icon green">â•</div>
                            <div class="quick-action-text">
                                <h4>Add Event</h4>
                                <p>Create new event</p>
                            </div>
                        </div>
                        <div class="quick-action" onclick="handleSendEmail()">
                            <div class="quick-action-icon orange">ğŸ“§</div>
                            <div class="quick-action-text">
                                <h4>Send Emails</h4>
                                <p>Notify participants</p>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-card">
                        <h3>ğŸ• Recent Activity</h3>
                        <div class="activity-item">
                            <div class="activity-dot purple"></div>
                            <div class="activity-info">
                                <h4>New registration</h4>
                                <p>Team 18 joined PromptQuest</p>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-dot green"></div>
                            <div class="activity-info">
                                <h4>Winners announced</h4>
                                <p>UI Battle results published</p>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-dot orange"></div>
                            <div class="activity-info">
                                <h4>Photos uploaded</h4>
                                <p>6 new gallery images</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="security.js"></script>
    <script src="js/admin.js" type="module"></script>
</body>
</html>
